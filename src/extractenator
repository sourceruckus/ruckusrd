#!/bin/bash
#
# RuckusRD - a super awesome, yet simple, mkinitrd replacement
#
# Copyright 2012-2018 Michael D Labriola <michael.d.labriola@gmail.com>
#
# Licensed under the GPLv3. See the file COPYING for details. 
#
# This script is a utility for creating a self extracting executable that runs
# an install script after extracting to a temp directory.
#
# FIXME: fix lame command line parsing and add usage
#
# FIXME: add --compression=none|gzip|bzip2|xz
#
filename=$1
script=$2
shift 2
payload=$*
echo filename: $filename
echo script: $script
echo payload: $payload

# create the initial installer script
echo -n "creating $filename... "
cat > $filename <<EOF
#!/bin/sh
skip=__SKIP__

tmpdir=\`mktemp -dt \\\`basename \$0\\\`-XXXX\`

echo -n "extracting archive to \$tmpdir... "
(tail -n +\$skip \$0 | zcat | tar -x --no-same-owner --no-same-permissions -C \$tmpdir) && echo DONE || { echo FAIL; exit 1; }

pushd \$tmpdir >/dev/null
`cat $script`
popd >/dev/null

echo -n "removing \$tmpdir... "
rm -rf \$tmpdir && echo DONE || { echo FAIL; exit 1; }

exit 0
EOF
[ $? -eq 0 ] && echo DONE || { echo FAIL; exit 1; }

# sed the actual length into it
skip=$((`wc -l $filename | awk '{print $1}'`+1))
echo skip: $skip
sed -i "s|__SKIP__|$skip|" $filename

# and now append the payload
echo -n "appending payload... "
(tar -c $payload | gzip >> $filename) || { echo FAIL; exit 1; }
echo DONE

# and make it executable
echo -n "making $filename executable... "
chmod +x $filename && echo DONE || { echo FAIL; exit 1; }

exit 0
