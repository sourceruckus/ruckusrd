#!/bin/bash
#
# RuckusRD - a super awesome, yet simple, mkinitrd replacement
#
# Copyright 2012-2018 Michael D Labriola <michael.d.labriola@gmail.com>
#
# Licensed under the GPLv3. See the file COPYING for details. 
#
# This script is a utility for creating a self-extracting installer for a built
# Linux kernel.  First run `kernel_builder`, then run this.
#
# FIXME: convert to extractenator usage...
#
#        - Split installer script into a standalone file?  Or embed it here as
#          an additional here-doc.
#
#        - We will be untaring into a /tmp dir now, with a script that copies
#          from there into the appropriate locations.
#
export SRP_ROOT=$PWD/FOO

VERSION=$(basename $SRP_ROOT/lib/modules/*)

filename=$PWD/kernel-installer-$VERSION.sh

echo VERSION: $VERSION
echo filename: $filename

# setup a tmpdir
tmpdir=\`mktemp -dt \\\`basename \$0\\\`-XXXX\`

# create the installer script
cat > $tmpdir/installer <<EOF
echo -n "removing preexisting modules in /lib/modules/$VERSION... "
rm -rf /lib/modules/$VERSION && echo DONE || { echo FAIL; exit 1; }

echo -n "extracting archive... "
tar -C FOO | tar -x --no-same-owner --no-same-permissions -C / && echo DONE || { echo FAIL; exit 1; }

echo "!! don't forget to update your bootloader (e.g., grub, extlinux) !!"
EOF

extractenator $filename $tmpdir/installer FOO || exit 1

rm -rf $tmpdir
exit 0
